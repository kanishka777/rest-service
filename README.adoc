import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.zaxxer.hikari.HikariDataSource;
import jakarta.annotation.PostConstruct;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;
import software.amazon.awssdk.services.secretsmanager.SecretsManagerClient;
import software.amazon.awssdk.services.secretsmanager.model.GetSecretValueRequest;
import software.amazon.awssdk.services.secretsmanager.model.SecretsManagerException;

@Slf4j
@Service
public class DbCredentialsRefresher {

    private final HikariDataSource hikariDataSource;
    private final SecretsManagerClient secretsClient;
    private final ObjectMapper objectMapper = new ObjectMapper();

    // AWS Secrets Manager secret name
    private final String secretName = "my-db-secret";

    private String currentPassword;

    public DbCredentialsRefresher(HikariDataSource hikariDataSource,
                                  SecretsManagerClient secretsClient) {
        this.hikariDataSource = hikariDataSource;
        this.secretsClient = secretsClient;
    }

    @PostConstruct
    public void init() {
        this.currentPassword = hikariDataSource.getHikariConfigMXBean().getPassword();
        log.info("Initialized DB credentials refresher with current HikariCP password.");
    }

    @Scheduled(fixedDelay = 300000) // every 5 minutes
    public void refreshDbCredentials() {
        try {
            String secretJson = secretsClient.getSecretValue(
                    GetSecretValueRequest.builder().secretId(secretName).build()
            ).secretString();

            JsonNode node = objectMapper.readTree(secretJson);
            String newPassword = node.get("password").asText();

            if (!newPassword.equals(currentPassword)) {
                currentPassword = newPassword;

                hikariDataSource.getHikariConfigMXBean().setPassword(newPassword);
                hikariDataSource.getHikariPoolMXBean().softEvictConnections();

                log.info("DB password rotated successfully. Hikari pool evicted and refreshed.");
            } else {
                log.debug("No DB password change detected in AWS Secrets Manager.");
            }
        } catch (SecretsManagerException e) {
            log.error("Failed to fetch DB secret from AWS Secrets Manager: {}", e.awsErrorDetails().errorMessage(), e);
        } catch (Exception e) {
            log.error("Unexpected error while refreshing DB credentials", e);
        }
    }
}



package com.example.demo.service;

import com.zaxxer.hikari.HikariConfigMXBean;
import com.zaxxer.hikari.HikariDataSource;
import com.zaxxer.hikari.HikariPoolMXBean;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import software.amazon.awssdk.services.secretsmanager.SecretsManagerClient;
import software.amazon.awssdk.services.secretsmanager.model.GetSecretValueRequest;
import software.amazon.awssdk.services.secretsmanager.model.GetSecretValueResponse;

import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

class DbCredentialsRefresherTest {

    private HikariDataSource hikariDataSource;
    private HikariConfigMXBean configMXBean;
    private HikariPoolMXBean poolMXBean;
    private SecretsManagerClient secretsClient;
    private DbCredentialsRefresher refresher;

    @BeforeEach
    void setUp() {
        // Mock HikariCP internals
        hikariDataSource = mock(HikariDataSource.class);
        configMXBean = mock(HikariConfigMXBean.class);
        poolMXBean = mock(HikariPoolMXBean.class);

        when(hikariDataSource.getHikariConfigMXBean()).thenReturn(configMXBean);
        when(hikariDataSource.getHikariPoolMXBean()).thenReturn(poolMXBean);
        when(configMXBean.getPassword()).thenReturn("initialPass");

        // Mock AWS Secrets Manager
        secretsClient = mock(SecretsManagerClient.class);

        // Create service under test
        refresher = new DbCredentialsRefresher(hikariDataSource, secretsClient);
        refresher.init(); // simulate @PostConstruct
    }

    @Test
    void testNoPasswordChange_NoUpdate() throws Exception {
        // Secret returns same password
        String secretJson = "{\"username\":\"user\",\"password\":\"initialPass\"}";
        when(secretsClient.getSecretValue(any(GetSecretValueRequest.class)))
                .thenReturn(GetSecretValueResponse.builder().secretString(secretJson).build());

        refresher.refreshDbCredentials();

        // Verify: no update called
        verify(configMXBean, never()).setPassword(anyString());
    }

    @Test
    void testPasswordChange_UpdatesPassword() throws Exception {
        // Secret returns new password
        String secretJson = "{\"username\":\"user\",\"password\":\"newPass123\"}";
        when(secretsClient.getSecretValue(any(GetSecretValueRequest.class)))
                .thenReturn(GetSecretValueResponse.builder().secretString(secretJson).build());

        refresher.refreshDbCredentials();

        // Verify: password updated
        verify(configMXBean).setPassword("newPass123");
    }
}
